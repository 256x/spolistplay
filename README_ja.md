# spolistplay: コマンドライン Spotify プレイリストプレイヤー

`spolistplay` は、Spotify のプレイリストを検索、選択し、再生デバイスを選んで、対話的なインターフェースを使ってターミナルから直接再生を制御できる、Python で書かれたシンプルなコマンドラインツールです。

**注意:** このツールは、API を介した再生制御機能を利用するために **Spotify Premium アカウントが必須** です。

## 機能

*   キーワードで Spotify プレイリストを検索するか、自身のプレイリストを一覧表示します。
*   再生したいプレイリストを選択します。
*   利用可能な Spotify デバイスから再生デバイスを選択します。
*   再生制御（再生/一時停止、次へ、前へ、シャッフル、終了）のための対話的なターミナルインターフェース。
*   基本的なエラー処理とロギング。

## 要件

*   Python 3.x
*   **Spotify Premium アカウント**
*   あなたのアカウントでログインしている Spotify クライアント/デバイスが実行中であること

## インストール方法

1.  **リポジトリをクローンします:**
    ```bash
    git clone https://github.com/256x/spolistplay
    cd spolistplay
    ```
2.  **依存関係をインストールします:**
    pip を使って必要なライブラリをインストールします。
    ```bash
    pip install -r requirements.txt
    ```
    **Windows** の場合、ターミナルインターフェースで問題が発生する場合は、`windows-curses` パッケージが必要になる場合があります:
    ```bash
    pip install windows-curses
    ```

## 初回セットアップ (Spotify API 認証)

`spolistplay` は Spotify Web API を使用してあなたのアカウントと連携します。Spotify Developer ダッシュボードでアプリケーションを作成し、その認証情報を提供する必要があります。

1.  **Spotify Developer ダッシュボードへ移動します:**
    [https://developer.spotify.com/dashboard/applications](https://developer.spotify.com/dashboard/applications) にアクセスし、あなたの Spotify アカウントでログインします。

2.  **アプリケーションを作成します:**
    「Create app」をクリックします。名前（例: "spolistplay"）と説明を入力します。規約に同意します。

3.  **Client ID と Client Secret を取得します:**
    アプリが作成されると、そのダッシュボードが表示されます。「Client ID」がここに表示されています。「Show Client Secret」をクリックすると秘密鍵が表示されます。**Client Secret は機密情報ですので、厳重に管理してください。**

4.  **Redirect URI を設定します:**
    「Edit Settings」をクリックします。「Redirect URIs」の下に、`spolistplay` が使用する正確な URI を追加します。スクリプトのデフォルトは `https://127.0.0.1/` です。Spotify アプリケーション設定のリストに、*この正確な URI* を追加する必要があります。必要に応じて複数の URI を追加できますが、スクリプトで使用されるものが存在することを確認してください。
    *例:* `https://127.0.0.1/`

5.  **環境変数を設定します:**
    スクリプトは、あなたの Client ID、Client Secret、Redirect URI を環境変数から読み取ります。スクリプトを実行する前に、使用するターミナルセッションでこれらを設定してください。

    *   **Bash/Zsh (Linux, macOS):**
        ```bash
        export SPOTIPY_CLIENT_ID="YOUR_CLIENT_ID"
        export SPOTIPY_CLIENT_SECRET="YOUR_CLIENT_SECRET"
        export SPOTIPY_REDIRECT_URI="https://127.0.0.1/" # またはあなたが選択したURI
        ```
    *   **PowerShell (Windows):**
        ```powershell
        $env:SPOTIPY_CLIENT_ID="YOUR_CLIENT_ID"
        $env:SPOTIPY_CLIENT_SECRET="YOUR_CLIENT_SECRET"
        $env:SPOTIPY_REDIRECT_URI="https://127.0.0.1/" # またはあなたが選択したURI
        ```
    *   **Command Prompt (Windows):**
        ```cmd
        set SPOTIPY_CLIENT_ID="YOUR_CLIENT_ID"
        set SPOTIPY_CLIENT_SECRET="YOUR_CLIENT_SECRET"
        set SPOTIPY_REDIRECT_URI="https://127.0.0.1/" # またはあなたが選択したURI
        ```
    *(`"YOUR_CLIENT_ID"` と `"YOUR_CLIENT_SECRET"` を実際の認証情報に置き換えてください)。*

    永続的な設定には、これらの行をシェルのプロファイルファイル（`~/.bashrc`, `~/.zshrc`, `~/.profile` など）に追加するか、システム全体の環境変数を設定することを検討してください。

6.  **初回実行時の認証:**
    環境変数を設定した後、初めてスクリプトを実行すると、Spotify にログインしてアプリケーションにアクセス権限を付与するためのウェブブラウザが開く可能性があります。認証後、ブラウザは指定された Redirect URI にリダイレクトされます。

    **手動認証 (自動リダイレクトが失敗した場合):**
    自動リダイレクトやトークンの取得がうまくいかない場合があります。ブラウザが開いて `https://127.0.0.1/` （またはあなたが選択した URI）にリダイレクトされたにもかかわらず、スクリプトが進まない場合は:
    *   ブラウザのアドレスバーの URL を確認してください。`https://127.0.0.1/?code=AQC...&state=...` のようになっているはずです。
    *   ブラウザのアドレスバーから **URL 全体をコピー** します。
    *   `spolistplay.py` スクリプトを実行しているターミナルに戻ります。スクリプトは入力を待っているか、エラーメッセージを表示しているかもしれません。
    *   ターミナルに **コピーした URL を貼り付け** て Enter を押します。スクリプトが認証トークンを取得し、続行できるはずです。

    以降の実行では、トークンが期限切れになるかキャッシュが無効にならない限り、キャッシュされたトークンが使用され、ブラウザ操作は不要になります。

    キャッシュファイルは `~/.cache/spotify/.spotify_cache` に保存されます。

## 使い方

1.  初回セットアップを完了し、環境変数を設定したことを確認してください。
2.  Spotify クライアント（デスクトップ、モバイル）が実行中で、あなたのアカウントでログインしており、目的の再生デバイスが利用可能であることを確認してください。
3.  ターミナルからスクリプトを実行します:
    ```bash
    python spolistplay.py
    ```
4.  **プレイリストの検索または一覧表示:**
    *   検索語（例: "rock hits"）を入力して Enter を押すと、プレイリストが検索されます。
    *   `0` と入力して Enter を押すと、あなた自身の保存されたプレイリストが一覧表示されます。
    *   検索入力中に `ESC` を押すとプログラムが終了します。
5.  **プレイリストの選択:**
    見つかったプレイリストのリストが表示されます。再生したいプレイリストに対応する番号を入力し、Enter を押します。
6.  **デバイスの選択:**
    利用可能な Spotify デバイスのリストが表示されます。再生に使用したいデバイスに対応する番号を入力し、Enter を押します。
7.  **再生インターフェース:**
    プレイリストとデバイスが選択されると、スクリプトは対話的なターミナルインターフェースに切り替わり、再生情報と制御が表示されます。

    **再生制御:**

    | キー      | アクション                       |
    | :-------- | :------------------------------- |
    | `P` または `p` | 再生/一時停止の切り替え            |
    | `<` または `,` | 前のトラックを再生               |
    | `>` または `.` | 次のトラックを再生               |
    | `S` または `s` | シャッフルをオン/オフに切り替え    |
    | `ESC`     | プレイリスト検索に戻る             |
    | `X` または `x` | プログラムを終了 (再生を一時停止) |

    インターフェースは定期的に更新され、現在のトラック、アーティスト、アルバム、再生ステータス、シャッフル状態が表示されます。

## ヒントとトラブルシューティング

*   **Spotify Premium:** API を介した再生制御（特定のデバイスでの再生開始、スキップ、一時停止、シャッフル）には Spotify Premium が必須です。
*   **デバイスが見つからない:** Spotify クライアント（デスクトップ、モバイル）が実行中で、ログインしており、ネットワーク上で認識されていることを確認してください。API に認識されるように、一度デバイスで手動で再生を開始する必要がある場合があります。
*   **認証エラー:** Client ID、Client Secret、Redirect URI の環境変数と Spotify Developer ダッシュボードの設定を再確認してください。Redirect URI が *正確に* 同じであることを確認してください。キャッシュファイル（`~/.cache/spotify/.spotify_cache`）を削除して、強制的に再認証を試みてください。ブラウザが開いたにもかかわらずスクリプトが止まった場合は、ブラウザの最終的な URL をコピーしてターミナルに貼り付けることを忘れないでください。
*   **ターミナル互換性:** 対話的なインターフェースはターミナルの機能を使用します。使用しているターミナルが基本的な全画面表示やキー入力処理をサポートしていることを確認してください。Windows の場合は、`windows-curses` のインストールが役立つかもしれません。
*   **`getch` の問題:** 文字入力（`getch`）は基本的な方法で実装されています。すべてのターミナルタイプや設定で完全に動作するとは限りません。

## ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。詳細は `LICENSE` ファイルを参照してください。

## クレジット

*   Spotify Web API と連携するために `spotipy` ライブラリ ([https://spotipy.readthedocs.io/en/2.24.0/](https://spotipy.readthedocs.io/en/2.24.0/)) を使用しています。

